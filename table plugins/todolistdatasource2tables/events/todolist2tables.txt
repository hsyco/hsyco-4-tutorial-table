INIT : {
    var dbConn = java.sql.DriverManager.getConnection("jdbc:hsqldb:file:data/hsyco;hsqldb.write_delay_millis=100;hsqldb.log_data=false;hsqldb.lock_file=false", "hsyco", "9h6s2y5c17o");
    dbConn.setAutoCommit(true);

    if (!databaseExecuteStatement(dbConn, "set database sql unique nulls false")) {
        errorLog("STARTUP ERROR: TODOLIST DATABASE: Failed to execute: set database sql unique nulls false");
    }
    
    if (databaseExecuteStatement(dbConn, "create table todolist1 (id integer generated by default as identity (start with 1) primary key, date date not null, time time not null, info varchar_ignorecase(256) not null)")) {
        messageLog("TABLE todolist1 created");
    }
    
    if (databaseExecuteStatement(dbConn, "create table todolist2 (id integer generated by default as identity (start with 1) primary key, id_nested integer not null, info varchar_ignorecase(256) not null, foreign key (id_nested) references todolist1)")) {
        messageLog("TABLE todolist2 created");
    }

    dataSourceSQL("db_todolist1", "todolist1", "id", dbConn);
    dataSourceOption("db_todolist1", "query.select", "todolist1.*, '{\"buttonlabel\":\"' + (select count(*) from todolist2 where id_nested = todolist1.id) + '\"}' as items");

    dataSourceSQL("db_todolist2", "todolist2", "id", dbConn);
    dataSourceOption("db_todolist2", "touch", "db_todolist1");
}

function userCommand(session, userid, name, param) : {
    if (name == "showtodolist2") {
        dataSourceOption(session, "db_todolist2", "values", {"id_nested" : param});
        return "!page:page2";
    }
    
    if(name == "cleardb"){
        if(!databaseExecuteStatement(dbConn, "DELETE FROM todolist2")){
            errorLog("DB: Failed to execute: DELETE FROM todolist2");
        }
        if(!databaseExecuteStatement(dbConn, "DELETE FROM todolist1")){
            errorLog("DB: Failed to execute: DELETE FROM todolist1");
        }
        dataSourceOption("db_todolist2", "touch", "db_todolist1");
        dataSourceOption("db_todolist1", "touch", "db_todolist2");
        return "ok";
    }
}
